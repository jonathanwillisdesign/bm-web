---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/Section.astro';
import Button from '../../components/Button.astro';
import CaseStudyCard from '../../components/CaseStudyCard.astro';

export async function getStaticPaths() {
  const caseStudies = await getCollection('case-studies');
  return caseStudies.map((study, index, array) => {
    // Calculate next case study (loop to first if at end)
    const nextIndex = (index + 1) % array.length;
    const nextStudy = array[nextIndex];

    return {
      params: { slug: study.slug },
      props: {
        study,
        nextStudy,
      },
    };
  });
}

interface Props {
  study: CollectionEntry<'case-studies'>;
  nextStudy: CollectionEntry<'case-studies'>;
}

const { study, nextStudy } = Astro.props;
const { Content } = await study.render();

// Get all services to map IDs to titles
const allServices = await getCollection('services');
const serviceMap = new Map(allServices.map(s => [s.id, s.data.title]));

// Get service titles from IDs
const serviceTitles = study.data.services?.map(serviceId => {
  return serviceMap.get(serviceId) || serviceId;
}) || [];

const teamMembers = study.data.team ? await getCollection('team', ({ id }) =>
  study.data.team?.includes(id)
) : [];
---

<BaseLayout
  title={`${study.data.title} - Big Motive`}
  description={study.data.description}
>
  {study.data.heroImage && (
    <div class="hero-image">
      <img src={study.data.heroImage} alt={study.data.title} />
    </div>
  )}

  <Section variant="standard">
    <div class="case-study-header">
      <h1 class="heading-medium">{study.data.title}</h1>
      <p class="body-large case-study-description">{study.data.description}</p>

      <div class="case-study-meta">
        <div class="meta-item">
          <span class="body-medium meta-label">Client</span>
          <span class="body-large-bold">{study.data.client}</span>
        </div>
        {study.data.duration && (
          <div class="meta-item">
            <span class="body-medium meta-label">Duration</span>
            <span class="body-large-bold">{study.data.duration}</span>
          </div>
        )}
        {serviceTitles.length > 0 && (
          <div class="meta-item">
            <span class="body-medium meta-label">Services</span>
            <span class="body-large-bold">{serviceTitles.join(', ')}</span>
          </div>
        )}
      </div>
    </div>
  </Section>

  {study.data.outcome && (
    <Section variant="accent">
      <div class="outcome-section">
        <h2 class="body-large-bold">Outcome</h2>
        <p class="body-large">{study.data.outcome}</p>
      </div>
    </Section>
  )}

  <Section variant="light">
    <article class="case-study-content">
      <Content />
    </article>
  </Section>

  {teamMembers.length > 0 && (
    <Section variant="light">
      <div class="team-section">
        <h2 class="heading-medium">Team Members</h2>
        <div class="team-grid">
          {teamMembers.map((member) => (
            <div class="team-member">
              {member.data.image && (
                <div class="team-member-image">
                  <img src={member.data.image} alt={member.data.name} />
                </div>
              )}
              <h3 class="body-large-bold">{member.data.name}</h3>
              <p class="body-medium team-role">{member.data.role}</p>
            </div>
          ))}
        </div>
      </div>
    </Section>
  )}

  <Section variant="standard">
    <div class="next-case-study">
      <div class="next-case-study__header">
        <h2 class="heading-medium">Next Project</h2>
        <Button variant="secondary" href="/work">View All Work</Button>
      </div>
      <CaseStudyCard
        title={nextStudy.data.title}
        client={nextStudy.data.client}
        description={nextStudy.data.description}
        category={nextStudy.data.services?.[0] ? (serviceMap.get(nextStudy.data.services[0]) || nextStudy.data.services[0]) : 'Project'}
        image={nextStudy.data.heroImage}
        href={`/work/${nextStudy.slug}`}
      />
    </div>
  </Section>
</BaseLayout>

<style>
  .hero-image {
    width: 100%;
    max-height: 600px;
    overflow: hidden;
    background-color: var(--surface-light);
  }

  .hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .case-study-header {
    display: flex;
    flex-direction: column;
    gap: var(--content-gap-medium);
    width: 100%;
  }

  .case-study-description {
    max-width: 800px;
  }

  .case-study-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--content-gap-medium);
    padding-top: var(--content-gap-small);
    border-top: 2px solid var(--border-standard);
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--content-gap-tiny);
  }

  .meta-label {
    color: var(--text-alternative);
  }

  .outcome-section {
    display: flex;
    flex-direction: column;
    gap: var(--content-gap-small);
    width: 100%;
  }

  .case-study-content {
    display: flex;
    flex-direction: column;
    gap: var(--content-gap-medium);
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
  }

  .case-study-content :global(h1),
  .case-study-content :global(h2),
  .case-study-content :global(h3) {
    margin-top: var(--content-gap-medium);
  }

  .case-study-content :global(h1) {
    font-size: var(--heading-medium-size);
    font-weight: var(--heading-medium-weight);
    line-height: var(--heading-medium-line-height);
    letter-spacing: var(--heading-medium-letter-spacing);
  }

  .case-study-content :global(h2) {
    font-size: var(--body-large-size);
    font-weight: var(--body-large-bold-weight);
    line-height: var(--body-large-line-height);
    letter-spacing: var(--body-large-letter-spacing);
  }

  .case-study-content :global(p) {
    font-size: var(--body-medium-size);
    font-weight: var(--body-medium-weight);
    line-height: var(--body-medium-line-height);
    letter-spacing: var(--body-medium-letter-spacing);
  }

  .case-study-content :global(img) {
    width: 100%;
    height: auto;
    border-radius: var(--radius-medium);
  }

  .team-section {
    display: flex;
    flex-direction: column;
    gap: var(--content-gap-medium);
    width: 100%;
  }

  .team-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--content-gap-medium);
  }

  .team-member {
    display: flex;
    flex-direction: column;
    gap: var(--content-gap-tiny);
  }

  .team-member-image {
    width: 100%;
    aspect-ratio: 1;
    overflow: hidden;
    background-color: var(--surface-light);
    border-radius: var(--radius-medium);
    margin-bottom: var(--content-gap-small);
  }

  .team-member-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .team-role {
    color: var(--text-alternative);
  }

  .next-case-study {
    display: flex;
    flex-direction: column;
    gap: var(--content-gap-large);
    width: 100%;
  }

  .next-case-study__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }

  @media (max-width: 768px) {
    .case-study-meta {
      grid-template-columns: 1fr;
    }

    .next-case-study__header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--content-gap-medium);
    }
  }
</style>
